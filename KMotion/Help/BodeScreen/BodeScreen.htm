<!DOCTYPE html>
<html>
<head>

<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>

<meta name="keywords" content="ethernet 16-axis controller, cnc control, motion control, cnc boards, 4-axis, 8-axis, stepper, brushless, DC motor, servo, encoder, adc, dac, motion controller, automated motion, manufacturing, Mach3">
<meta name="description" content="Manufacturer of premium motion control products for CNC Manufacturing, Robotics and Automation">
<meta http-equiv="Content-Type" content="text/html; charset=windows-1252">
<meta http-equiv="Content-Language" content="en-us">

<title>Bode Screen</title>

<link rel="stylesheet" type="text/css" href="../css/style.css">
<link rel="stylesheet" href="../css/prism.css" data-noprefix />
<script src="../js/prism.js"></script>
</head>

<body>

<div id="logo"><a href="../index.htm"></a></div>

<div id="home">
<a href="../index.htm">Table of contents</a> |  
	<script>
		if (navigator.userAgent.indexOf("NT 6.2") == -1){
			document.write('<a href="https://www.dynomotion.com">Dynomotion home page</a>')
		} else {
			document.write('<a href="https://www.dynomotion.com" target="_blank">Dynomotion home page</a>')
		}
	</script>
</div>
	

<div id="searchNav">

	<div class="gcse-search">
					<script>
					  if (document.location.protocol  ==  'https:') {
					  (function() {
					  var cx = '012657033059195044748:9fmjmlufts0';
					  var gcse = document.createElement('script');
					  gcse.type = 'text/javascript';
					  gcse.async = true;
					  gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
					      '//cse.google.com/cse.js?cx=' + cx;
					  var s = document.getElementsByTagName('script')[0];
					  s.parentNode.insertBefore(gcse, s);
					})();
					  }
				      </script> 
				      <gcse:search> </gcse:search>  

	       </div>
</div>	

	


<div id="google_translate_element" style="background: transparent;" align="right"><script type="text/javascript">
if (navigator.userAgent.indexOf("NT 6.2") == -1) {
		function googleTranslateElementInit() {
	  new google.translate.TranslateElement({pageLanguage: 'en', includedLanguages: 'en,de,fr,it,es,pt,ru,uk,ar,zh-CN,zh-TW,ko,iw,hi,ja,tr', layout: google.translate.TranslateElement.InlineLayout.SIMPLE}, 'google_translate_element');
		}						}
	</script>
	<script type="text/javascript" src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit">
	</script>
</div>		

	
<div id="main">	

<h1>Bode Plot Screen</h1>
<p><map name="FPMap0">
<area href="#Measurement" shape="rect" coords="14, 35, 137, 66">
<area href="#Amplitude" shape="rect" coords="13, 72, 215, 157">
<area href="#Measurement" shape="rect" coords="12, 166, 194, 260">
<area href="#Axis_Control" shape="rect" coords="13, 261, 114, 391">
<area href="#Save/Load_Data" shape="rect" coords="14, 393, 124, 448">
<area href="#Update_Pushbutton" shape="rect" coords="14, 450, 123, 487">
<area href="#PlotType" shape="rect" coords="328, 34, 834, 68">
<area href="#0_db_crossover" shape="rect" coords="264, 510, 782, 540">
<area href="#Bode_plot" shape="rect" coords="254, 74, 849, 509"></map>
<img src="BodeScreen.PNG" width="857" height="552" usemap="#FPMap0"></p>

<p class="small">(Click on above image to jump to relative topic)</p>

<p>The <em><strong> Bode Plot Screen</strong></em> allows the measurement of a servo loop 
and graphs the open loop response. A Bode Plot is by far the most common 
means used to measure and understand the behavior of a control loop. <em>
<strong>KMotion</strong></em> contains advanced built-in 
features to allow rapid Bode Plot measurement and display. The current PID and IIR Filter transfer 
functions may also be superimposed and graphed.</p>

<p>A <a name="Bode_Plot">Bode Plot</a> is a plot of magnitude and phase of a system with respect 
to frequency. Any linear system that is driven by a sinusoidal input for a 
long time, will output an sinusoidal signal of the same frequency. The output signal may be shifted in phase and of a different magnitude than the 
input. A Bode plot is a graph of both the change in phase and the relative 
change in magnitude (expressed in decibels, db), as a function of frequency.</p>

<p>A Bode plot is a useful tool used to examine the stability of a servo 
feedback loop. If a system has an open loop gain of -1 (magnitude of 0 db 
and phase of -180 degrees), then if it is placed into a negative feedback loop, 
it will become unstable and oscillate. Because a system's gain and phase 
vary as function of frequency, if the system has a magnitude of 0db and phase of 
-180 degrees at <em>any frequency</em> it will be unstable and oscillate at that 
frequency. The way to avoid an unstable system is to avoid having 
simultaneous 
conditions of 0db and -180 degrees occur at any frequency. Where the 
magnitude of the system is 0db the amount that the phase is different from -180 
degrees is called the <em><a name="phase_margin">phase margin</a></em>. The larger the phase margin the 
more stable the system. Similarly where the phase is -180 degrees the 
amount that the magnitude is different from 0db is called the <em>gain margin</em>. 
Again the larger the gain margin, the more stable the system. As a general 
rule of thumb, for a system to be reasonably stable it should have a phase 
margin of at least 30 degrees and a gain margin of at least 3 db.</p>

<p>The Bode Plot Screen attempts to identify and measure the
<a name="0_db_crossover">0 db crossover</a> frequency (the first point where the 
open loop magnitude becomes less than 1, often defined as the system bandwidth, 
228 Hz on the example above), the gain and phase margins, and one or two sharp 
peaks in the magnitude data after the crossover. Some mechanical systems 
have sharp resonant peaks that may cause the system to go unstable if these 
peaks approach the 0 db line and have phase near -180 degrees. A notch 
filter placed at these frequencies may increase performance. The 
measurements are displayed under the graph as shown below.</p>

<p><img src="BodeSc6.gif" alt="Bode Screen" /></p>

<div style="float: left; margin-right: 5px;"><img src="OpenClosedLoop.PNG" width="432" height="326" alt="Open Closed Loop" /></div>

<p>The most direct method for obtaining the open loop response, is to 
break the servo loop open, inject a signal into the system and measure the 
output. However this is usually impractical as most systems will run out 
of their linear range if driven in an open loop manner. <em><strong>KMotion</strong></em> 
operates the servo loop in its normal closed loop form, injects a command 
signal, measures the position response, and mathematically derives the 
open loop response. This does require that the servo loop function in some 
form as a stable closed loop servo <em>before</em> a measurement may be made. 
Performance is not a requirement so low gains might be used to obtain an initial 
stable system.</p>

<div style="clear: both;"></div>

<div style="float: left; margin-right: 5px;"><img src="BodeSc2.gif" alt="Bode Screen" /></div>

<p>To perform a <em>Bode Plot</em> <a name="Measurement">Measurement</a>: select 
the <em>channel</em> to measure, select the desired <a href="#Amplitude"><em>
Amplitude</em> and <em>Cutoff Frequency</em></a> for the stimulus to be injected, 
select the <em># of sample</em>s to average, and depress the <em>Measure</em> 
Pushbutton. All current Configuration Parameters (from the
<a href="../ConfigurationScreen/ConfigurationScreen.htm">Configuration Screen</a>), 
Tuning Parameters (from the <a href="../StepScreen/StepScreen.htm">Step Response 
Screen</a>), and Filter Parameters (from the
<a href="../FilterScreen/FilterScreen.htm">IIR Filter Screen</a>) will be 
downloaded, the selected Axis channel will be enabled, and the measurement will 
begin.</p>

<p>While the measurement is in progress the number of samples acquired will be 
displayed and the <em>Measure</em> Pushbutton will change to a <em>Stop</em> 
Pushbutton. Pushing the Stop button will stop acquiring data after the 
current sample is complete. </p>
<p>Depending on the type of plot requested (either Time Domain or Frequency 
Domain) either the last acquired time domain measurement will be displayed or 
the <em>average</em> all the frequency domain measurement so far acquired will be 
displayed.</p>

<div style="clear: both;"></div>

<div style="float: left; margin-right: 5px;"><img src="NoiseRegions.PNG" width="314" height="298" alt="Noise Regions" /></div>

<p>Unfortunately Bode Plots often have regions that are very noisy. But <em>
fortunately</em> these are almost always in regions that are not important to us. 
At frequencies where the open loop gain is very high (usually at low 
frequencies), the servo loop performs very well, and the <em>Position</em> 
closely matches the <em>Command </em>signal. In this case, the calculation 
of the <em>Error</em> signal (see above) is calculated by taking the difference 
between two nearly equal values. A small error in Position measurement 
will then result in a relatively large error in the calculated error value. 
Similarly, when the system has a very low gain (usually at high frequencies), 
the position signal is very small and often highly influenced by noise, or if an 
encoder is used, by encoder resolution. The regions of interest in order to 
determine system stability, are where the open loop gain is near 0db and the 
measurements are normally very accurate.</p>

<p>Additionally, instead of injecting sine waves at various frequencies 
individually, <em><strong>KMotion</strong></em> uses a technique where a random noise signal 
that is rich in <em>many</em> frequencies is injected. Using a method 
involving an FFT (Fast Fourier Transform) of the input and output, the entire 
frequency response may be obtained at once.</p>

<div style="clear: both;"></div>

<p>Bode Plot analysis is fundamentally based on the assumption that the system being 
analyzed is <em><a name="linear">linear</a></em>. Linear in this context means that any signal 
injected into a system that provides a response, might be broken into parts, 
each piece injected separately, and all the resulting responses when summed 
would equal the original response. If a system being measured does not 
meet this criteria then the result is basically useless and meaningless. 
Masses, Springs, Dampers, Inductors, Resistors, Capacitors, and all combinations 
thereof are examples of devices which produce very linear effects. Static 
friction, Saturation, and Encoder count quantization, are examples of non-linear 
effects.</p>

<div style="float: left; margin-right: 5px;"><img src="BodeSc1.gif" alt="Bode Screen" /></div>

<a name="Amplitude"></a>It is 
therefore very important to verify that while the system is being measured that 
it is operating in its linear range. This usually entails that the system 
isn't being driven too hard (or too fast), so that the drive to the system (<em>Output</em>) 
is not reaching saturation. Additionally, it is important to verify that 
the system is being driven sufficiently hard (or slowly enough) that a 
measurable <em>Position</em> change is being observed. The <em>Noise 
Injection Amplitude </em>and <em>Cutoff Frequency</em> should be adjusted to 
optimize these conditions. <em>Noise</em> <em>Amplitude</em> has the same 
units as <em>Position</em> Measurement. It should be noted that setting the
<em>Cutoff Frequency</em> very low, may reduce the high frequency stimulation to 
the system to such a point that the higher frequency measurements are invalid or 
very noisy. </p>

<div style="clear: both;"></div>

<p><a name="PlotType"></a>The Bode Plot Screen allows the measurement data to be 
viewed in the <em>time domain</em> in order to check the signal amplitudes so that 
the optimal signal levels may be used in order to minimize the non-linear 
effects of saturation and quantization. Select the Plot Type drop down 
list shown below to switch between frequency domain and dime domain displays.</p>

<p><img src="PlotTypes.PNG" width="491" height="58" alt="Plot Types" /></p>

<p>A typical time domain measurement is shown below. The <em>blue</em> graph 
shows the random stimulus to the system. The <em>red</em> graph shows the 
system's response, which in this example is the output of an encoder. Note 
that the position is quantized to integer counts and has a range of 
approximately 10 counts. This is nearly the minimum number of counts to 
expect a reasonable Bode Plot measurement. A larger range of encoder 
counts could be obtained by driving the system harder by increasing the Noise 
Injection Amplitude, provided there is additional output drive available. </p>

<p><img src="CommandAndPosition.PNG" width="857" height="552" alt="Command and Position" /></p>

<p>The graphs below include the output drive signal shown in <em>green</em>. 
Note that the output drive is on the verge of saturating at the maximum allowed 
output value (example is from a 3 phase brushless motor, maximum allowed PWM 
counts of 230). This shows that we are driving the system as hard as 
possible without saturating in order to obtain the most accurate measurement.</p>

<p>Another means of improving the measurement accuracy (as well as servo 
performance in general) is obviously to increase the encoder resolution if 
economically or otherwise feasible. </p>

<p><img src="CommandPositionOutput.PNG" width="857" height="552" alt="Command and Position" /></p>

<h2><a name="Compensator_Response">Compensator Response</a></h2>

<p><img src="Compensator.PNG" width="620" height="295" /></p>
<p>The <em>Bode Plot Screen</em> is also capable of graphing a <em>Bode Plot</em> of 
the combined PID and IIR Filters. This is often referred to as the <em>
Compensator</em> for the system. The Cyan graph shows the magnitude of the 
compensator and the violet graph shows the phase of the compensator. 
Notice that in this example the maximum phase has been adjusted to match the 0 
db crossover frequency of the system (~ 233 Hz) to maximize the system phase 
margin.</p>

<p><img src="FilterMagAndPhase.PNG" width="857" height="552" alt="PID and IIR Filters" /></p>

<h2><a name="Axis_Control">Axis Control</a></h2>

<div style="float: left; margin-right: 5px;"><img src="BodeSc3.gif" alt="Kill, Zero, Enable" /></div>

<p>The Axis Control buttons are present to conveniently disable (Kill), Zero, or 
Enable an axis. If the axis becomes unstable (possible due to a gain 
setting too high), the Kill button may be used to disable the axis, the gain 
might then be reduced, and then the axis may be enabled. The Enable button 
downloads all parameters from all screens before enabling the axis in the same 
manner as the <em><a href="#Measurement">Measure</a></em> button described above.</p>

<p><em>Note for brushless output modes that commutate the motor based on the 
current position, Zeroing the position may adversely affect the commutation.</em></p>

<div style="clear: both;"></div>

<h2><a name="Save/Load_Data">Save/Load Data</a></h2>

<div style="float: left; margin-right: 5px;"><img src="BodeSc4.gif" alt="Save, Load Data" /></div>
<p>The Save/Load Data buttons allow the captured Bode Plot to be saved to a text file 
and re-loaded at a later time. The text file format also allows the data 
to be imported into some other program for display or analysis. The file 
format consists of one line of header followed by one line of 9 comma separated 
values, one line for each frequency.</p>

<div style="clear: both;"></div>

<p> The values are:</p>
<ol>
  <li>Frequency in Hz</li>
  <li>Input Stimulus - Real Part of complex number</li>
  <li>Input Stimulus - Complex Part of complex number (always zero)</li>
  <li>Measured Closed Loop Output - Real Part of complex number</li>
  <li>Measured Closed Loop Output - Complex Part of complex number </li>
  <li>Open loop Magnitude - in decibels</li>
  <li>Open loop Phase - in degrees</li>
  <li>Open loop Magnitude - in decibels - &quot;smoothed&quot;</li>
  <li>Open loop Phase - in degrees - &quot;smoothed&quot;</li>
</ol>

<p>Example of data file follows:</p>

<pre>
	Freq		InputRe 	InputIm	OutputRe	OutputIm	Mag 		Phase		SmoothMag	SmoothPhase
	0		2.329706e+007	0	2.344316e+007	0		44.10739	-180		0		0
	5.425347	1.968735e+007	0	1.98995e+007	-32055.19	39.34598	-171.5001	39.34598	-171.5001
	10.85069	1.816919e+007	0	1.848909e+007	-713239.6	27.48402	-116.3662	29.58283	-139.1553
	16.27604	2.024904e+007	0	2.124962e+007	-1383543	21.91849	-129.5997	25.14718	-134.5283
	21.70139	1.53403e+007	0	1.645491e+007	-1651059	18.38331	-129.7526	22.70204	-127.6139
	27.12674	1.225619e+007	0	1.301412e+007	-1336369	18.60411	-125.4229	20.60267	-123.6751
	32.55208	7014539		0	7393482		-958714.3	17.18516	-118.9553	18.9778		-119.2762
	.
	.
	.
</pre>

<h2><a name="Update_Pushbutton">Update Pushbutton</a></h2>

<div style="float: left; margin-right: 5px;"><img src="BodeSc5.gif"></div>
<p>The Update button may be used to update the displayed <em>
<a href="#Compensator_Response">compensator</a></em> graph if any parameters (on 
other screens) have been modified and not downloaded or otherwise acted upon. 
If Measure, Download, Step, Move, Save, Close, or Enable is used on this or the 
any other screen then this command is unnecessary, however if none of these 
commands is performed, then this button may be used to update the graph. </p>

<div style="clear: both;"></div>

</body>

</html>
